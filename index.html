<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
<title>Smart Home Solution - Invoice System</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    margin:0; 
    padding:20px; 
    color:#111; 
    min-height: 100vh;
  }
  .container { 
    max-width:1200px; 
    margin:auto; 
    background:#fff; 
    padding:30px 40px; 
    border-radius:16px; 
    box-shadow:0 20px 60px rgba(0,0,0,0.3); 
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid #667eea;
  }
  h1 { font-weight:700; color:#667eea; margin:0; font-size: 28px; }
  .settings-link { color:#667eea; text-decoration:none; font-weight:600; }
  .settings-link:hover { text-decoration:underline; }
  h2 { font-weight:600; color:#1f2937; margin-bottom:20px; font-size:20px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
  .form-group { display: flex; flex-direction: column; }
  label { display:block; margin-bottom:8px; font-weight:600; color:#4b5563; font-size:14px; }
  input, select, button, textarea { font-size:15px; }
  input, select, textarea { 
    width:100%; 
    padding:12px 14px; 
    border-radius:8px; 
    border:2px solid #e5e7eb; 
    transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { outline:none; border-color:#667eea; }
  .input-error { border-color:#dc2626 !important; }
  .error-message { font-size:12px; color:#dc2626; margin-top:4px; }
  .success-message { font-size:12px; color:#059669; margin-top:4px; }
  
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th,td { padding:12px 10px; border:1px solid #e5e7eb; text-align:center; font-size:14px; }
  th { background:#f3f4f6; font-weight:700; color:#374151; }
  .right { text-align:right; }
  td input { margin: 0; }
  
  button { 
    background:#667eea; 
    border:none; 
    border-radius:8px; 
    color:#fff; 
    font-weight:600; 
    padding:12px 20px; 
    cursor:pointer; 
    font-size:15px; 
    transition:all 0.3s ease; 
    margin-top:10px; 
    margin-right:12px; 
  }
  button:hover:enabled { background:#5568d3; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
  button:disabled { background:#9ca3af; cursor:not-allowed; transform: none; }
  button:active:enabled { transform: translateY(0); }
  
  .btn-secondary { background:#6b7280; }
  .btn-secondary:hover:enabled { background:#4b5563; }
  .btn-success { background:#059669; }
  .btn-success:hover:enabled { background:#047857; }
  .btn-danger { background:#dc2626; }
  .btn-danger:hover:enabled { background:#b91c1c; }
  
  .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
  
  #invoiceSummary { 
    margin-top:25px; 
    white-space:pre-wrap; 
    font-family:monospace; 
    background:#f9fafb; 
    padding:20px; 
    border-radius:8px;
    border: 2px solid #e5e7eb;
    max-height: 400px; 
    overflow-y: auto;
  }
  #qrCode, #reviewQrCode { 
    margin-top:20px; 
    text-align: center;
  }
  #qrCode canvas, #reviewQrCode canvas {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px;
  }
  
  .section { 
    background:#f9fafb; 
    padding:25px; 
    border-radius:12px; 
    margin-bottom:25px;
    border: 1px solid #e5e7eb;
  }
  
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideDown 0.3s;
  }
  
  @keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
  }
  
  .close:hover { color: #000; }
  
  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e5e7eb;
  }
  
  .tab {
    padding: 12px 24px;
    cursor: pointer;
    border: none;
    background: none;
    color: #6b7280;
    font-weight: 600;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
    margin: 0;
  }
  
  .tab:hover { color: #667eea; }
  .tab.active { color: #667eea; border-bottom-color: #667eea; }
  
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }
  
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .stat-label { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
  .stat-value { font-size: 28px; font-weight: 700; }
  
  .invoice-list {
    max-height: 400px;
    overflow-y: auto;
  }
  
  .invoice-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid #e5e7eb;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .invoice-item:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  }
  
  .invoice-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  
  .invoice-number { font-weight: 700; color: #667eea; }
  .invoice-date { color: #6b7280; font-size: 13px; }
  .invoice-customer { color: #374151; margin-bottom: 4px; }
  .invoice-amount { font-weight: 600; color: #059669; }
  
  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
    min-width: 70px;
  }
  
  .status-paid { background: #d1fae5; color: #065f46; }
  .status-partial { background: #dbeafe; color: #2563eb; }
  .status-pending { background: #fef3c7; color: #92400e; }
  .status-overdue { background: #fee2e2; color: #991b1b; }
  .status-quotation { background: #e0e7ff; color: #3730a3; }
  
  .discount-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }
  
  .discount-row .form-group {
    flex: 1;
  }
  
  @media (max-width: 768px) {
    .form-row { grid-template-columns: 1fr; }
    .container { padding: 20px; }
    .stats-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container" role="main" aria-label="Invoice application">
  <div class="header">
    <h1>üè† Smart Home Solution</h1>
    <a href="#" class="settings-link" id="openSettings">‚öôÔ∏è Settings</a>
  </div>

  <div class="tabs" role="tablist" aria-label="Invoice System Tabs">
    <button class="tab active" data-tab="create" role="tab" aria-selected="true" aria-controls="create-tab" id="tab-create">Create Invoice</button>
    <button class="tab" data-tab="manage" role="tab" aria-selected="false" aria-controls="manage-tab" id="tab-manage">Manage Invoices</button>
    <button class="tab" data-tab="dashboard" role="tab" aria-selected="false" aria-controls="dashboard-tab" id="tab-dashboard">Dashboard</button>
  </div>

  <div class="tab-content active" id="create-tab" role="tabpanel" aria-labelledby="tab-create" tabindex="0">
    <section class="section" aria-label="Customer Details">
      <h2>Customer Details</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="customerName">Customer Name *</label>
          <input id="customerName" placeholder="e.g. John Doe" autocomplete="name" required list="customerList" aria-required="true" />
          <datalist id="customerList"></datalist>
        </div>
        <div class="form-group">
          <label for="customerEmail">Customer Email</label>
          <input id="customerEmail" type="email" placeholder="email@example.com" autocomplete="email" aria-describedby="emailError" />
          <div id="emailError" class="error-message" style="display:none;" role="alert"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="customerPhone">Customer Phone *</label>
          <input id="customerPhone" placeholder="+256700000000" autocomplete="tel" aria-describedby="phoneError" aria-required="true" />
          <div id="phoneError" class="error-message" style="display:none;" role="alert"></div>
        </div>
        <div class="form-group">
          <label for="issuerName">Salesperson / Issuer *</label>
          <input id="issuerName" placeholder="Your name" autocomplete="name" required aria-required="true" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="paymentMethod">Payment Method</label>
          <select id="paymentMethod" aria-label="Select payment method">
            <option value="">Select method</option>
            <option value="cash">Cash</option>
            <option value="mobile_money">Mobile Money</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="credit_card">Credit Card</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dueDate">Due Date (for invoices)</label>
          <input id="dueDate" type="date" aria-label="Due date for invoice" />
        </div>
      </div>
    </section>

    <section class="section" aria-label="Invoice Items">
      <h2>Invoice Items</h2>
      <table id="itemsTable" role="grid" aria-label="Invoice Items Table">
        <thead>
          <tr>
            <th style="width:35%">Description</th>
            <th style="width:10%">Qty</th>
            <th style="width:15%">Unit Price (UGX)</th>
            <th style="width:12%">VAT Rate %</th>
            <th style="width:13%">VAT Amount (UGX)</th>
            <th style="width:15%">Line Total (UGX)</th>
            <th style="width:5%">Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="5" class="right">Subtotal:</td><td id="subtotal" class="right">0.00</td><td></td></tr>
          <tr id="discountRow" style="display:none;">
            <td colspan="5" class="right">Discount (<span id="discountDisplay">0</span>):</td>
            <td id="discountAmount" class="right">0.00</td>
            <td></td>
          </tr>
          <tr><td colspan="5" class="right">Total VAT:</td><td id="vat" class="right">0.00</td><td></td></tr>
          <tr style="font-weight:bold; background:#f3f4f6;"><td colspan="5" class="right">Grand Total:</td><td id="total" class="right">0.00</td><td></td></tr>
        </tfoot>
      </table>
      
      <div style="margin-top: 15px;">
        <button type="button" id="addItemBtn" aria-label="Add new invoice item row">+ Add Item</button>
        <div class="discount-row" style="margin-top: 15px; max-width: 400px;">
          <div class="form-group">
            <label for="discountValue">Discount</label>
            <input id="discountValue" type="number" min="0" step="0.01" value="0" aria-label="Discount value" />
          </div>
          <div class="form-group">
            <label for="discountType">Type</label>
            <select id="discountType" aria-label="Select discount type">
              <option value="percent">Percentage (%)</option>
              <option value="fixed">Fixed Amount</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <section class="section" aria-label="Payment and Notes">
      <h2>Payment & Notes</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="amountPaid">Amount Paid (UGX)</label>
          <input id="amountPaid" type="number" min="0" step="0.01" placeholder="0.00" aria-label="Enter amount paid" />
          <div style="margin-top:10px;">
            <strong>Outstanding Balance: </strong>
            <span id="balance" style="color:#dc2626; font-size:18px; font-weight:700;">0.00 UGX</span>
          </div>
        </div>
        <div class="form-group">
          <label for="notes">Notes / Terms & Conditions</label>
          <textarea id="notes" rows="3" placeholder="Add any additional notes or terms..." aria-label="Additional notes or terms"></textarea>
        </div>
      </div>
    </section>

    <div class="actions">
      <button id="generateInvoiceBtn" type="button">üìÑ Generate Invoice</button>
      <button id="generateQuotationBtn" type="button">üìã Generate Quotation</button>
      <button id="saveInvoiceBtn" type="button" disabled class="btn-success">üíæ Save Document</button>
      <button id="printPdfBtn" type="button" disabled>üñ®Ô∏è Print PDF</button>
      <button id="emailBtn" type="button" disabled>üìß Email to Customer</button>
      <button id="exportCsvBtn" type="button" class="btn-secondary">üìä Export to CSV</button>
      <button id="clearFormBtn" type="button" class="btn-secondary">üóëÔ∏è Clear Form</button>
    </div>

    <div id="invoiceSummary" tabindex="0" aria-live="polite"></div>
    <div id="qrCode" aria-label="Invoice QR Code"></div>
  </div>

  <div class="tab-content" id="manage-tab" role="tabpanel" aria-labelledby="tab-manage" tabindex="0">
    <section class="section">
      <h2>Search & Manage Documents</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="searchInvoiceNumber">Search by Number / Customer / Phone</label>
          <input id="searchInvoiceNumber" placeholder="Invoice number, customer name, or phone" aria-label="Search documents by number, customer or phone" />
        </div>
        <div class="form-group">
          <label for="filterStatus">Filter by Status</label>
          <select id="filterStatus" aria-label="Filter documents by status">
            <option value="">All</option>
            <option value="invoice">Invoices Only</option>
            <option value="quotation">Quotations Only</option>
            <option value="paid">Paid</option>
            <option value="partial">Partially Paid</option>
            <option value="pending">Pending</option>
            <option value="overdue">Overdue</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="dateFrom">Date From</label>
          <input id="dateFrom" type="date" aria-label="Start date for date filter" />
        </div>
        <div class="form-group">
          <label for="dateTo">Date To</label>
          <input id="dateTo" type="date" aria-label="End date for date filter" />
        </div>
      </div>
      <div class="actions">
        <button id="searchInvoiceBtn" type="button">üîç Search</button>
        <button id="clearSearchBtn" type="button" class="btn-secondary">Clear Filters</button>
      </div>
      
      <div id="invoiceListContainer" class="invoice-list" tabindex="0" aria-live="polite" aria-label="List of invoices"></div>
    </section>

    <section class="section" id="reviewSection" style="display:none;" aria-live="polite">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0;">Document Details</h2>
        <button id="closeReviewBtn" class="btn-secondary" style="margin: 0;">‚úï Close</button>
      </div>
      <pre id="reviewInvoiceSummary" style="white-space: pre-wrap; font-family: monospace; background:#f9fafb; padding:20px; border-radius:8px;"></pre>
      <div id="reviewQrCode" aria-label="Detailed document QR Code"></div>
      <div class="actions" style="margin-top: 20px;">
        <button id="editInvoiceBtn" type="button">‚úèÔ∏è Edit</button>
        <button id="printReviewBtn" type="button">üñ®Ô∏è Print</button>
        <button id="deleteInvoiceBtn" type="button" class="btn-danger">üóëÔ∏è Delete</button>
      </div>
    </section>
  </div>

  <div class="tab-content" id="dashboard-tab" role="tabpanel" aria-labelledby="tab-dashboard" tabindex="0">
    <section class="section" aria-label="Business Overview">
      <h2>Business Overview</h2>
      <div class="stats-grid" id="statsGrid" role="list">
        <div class="stat-card" role="listitem">
          <div class="stat-label">Total Sales</div>
          <div class="stat-value" id="statTotalSales">0 UGX</div>
        </div>
        <div class="stat-card" role="listitem">
          <div class="stat-label">Pending Payments</div>
          <div class="stat-value" id="statPending">0 UGX</div>
        </div>
        <div class="stat-card" role="listitem">
          <div class="stat-label">Total Invoices</div>
          <div class="stat-value" id="statInvoiceCount">0</div>
        </div>
        <div class="stat-card" role="listitem">
          <div class="stat-label">Quotations</div>
          <div class="stat-value" id="statQuotationCount">0</div>
        </div>
      </div>
    </section>

    <section class="section" aria-label="Recent Documents">
      <h2>Recent Documents</h2>
      <div id="recentInvoices" class="invoice-list" tabindex="0" aria-live="polite" aria-label="List of recent invoices"></div>
    </section>
  </div>
</div>

<div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalLabel">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="settingsModalLabel" style="margin: 0;">Settings</h2>
      <button aria-label="Close Settings" class="close" id="closeSettings">&times;</button>
    </div>
    <div class="form-group">
      <label for="companyName">Company Name</label>
      <input id="companyName" placeholder="Smart Home Solution" />
    </div>
    <div class="form-group">
      <label for="uraTin">URA TIN Number</label>
      <input id="uraTin" placeholder="1019781622" />
    </div>
    <div class="form-group">
      <label for="companyAddress">Company Address</label>
      <textarea id="companyAddress" rows="2" placeholder="Enter company address"></textarea>
    </div>
    <div class="form-group">
      <label for="companyPhone">Company Phone</label>
      <input id="companyPhone" placeholder="+256700000000" />
    </div>
    <div class="form-group">
      <label for="companyEmail">Company Email</label>
      <input id="companyEmail" type="email" placeholder="info@smarthome.com" />
    </div>
    <button id="saveSettings" class="btn-success">üíæ Save Settings</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.2/dexie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const db = new Dexie('InvoiceDB');
  db.version(3).stores({
    invoices: '++id,number,fiscalDocNo,type,customer,issuerName,email,phone,date,dueDate,total,status,*tags',
    settings: 'key',
    counters: 'type',
    customers: '++id,name,*phone,*email,lastTransaction',
    auditLog: '++id,documentId,action,timestamp,userId'
  }).upgrade(tx => {
    return tx.table('invoices').toCollection().modify(invoice => {
      if (!invoice.tags) invoice.tags = [];
      if (!invoice.lastModified) invoice.lastModified = invoice.date || new Date();
    });
  });

  let settings = {
    companyName: 'Smart Home Solution',
    uraTin: '1019781622',
    companyAddress: '',
    companyPhone: '',
    companyEmail: ''
  };

  async function loadSettings() {
    const settingsData = await db.settings.toArray();
    settingsData.forEach(item => settings[item.key] = item.value);
    updateSettingsUI();
  }

  function updateSettingsUI() {
    document.getElementById('companyName').value = settings.companyName || '';
    document.getElementById('uraTin').value = settings.uraTin || '';
    document.getElementById('companyAddress').value = settings.companyAddress || '';
    document.getElementById('companyPhone').value = settings.companyPhone || '';
    document.getElementById('companyEmail').value = settings.companyEmail || '';
  }

  document.getElementById('saveSettings').addEventListener('click', async () => {
    settings.companyName = document.getElementById('companyName').value;
    settings.uraTin = document.getElementById('uraTin').value;
    settings.companyAddress = document.getElementById('companyAddress').value;
    settings.companyPhone = document.getElementById('companyPhone').value;
    settings.companyEmail = document.getElementById('companyEmail').value;
    for (const key in settings) {
      await db.settings.put({ key, value: settings[key] });
    }
    alert('Settings saved successfully!');
    document.getElementById('settingsModal').style.display = 'none';
    updateDashboard();
  });

  document.getElementById('openSettings').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('settingsModal').style.display = 'block';
  });

  document.getElementById('closeSettings').addEventListener('click', () => {
    document.getElementById('settingsModal').style.display = 'none';
  });
  window.addEventListener('click', (e) => {
    if (e.target === document.getElementById('settingsModal')) {
      document.getElementById('settingsModal').style.display = 'none';
    }
  });

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      tab.setAttribute('aria-selected', 'true');
      const tabId = tab.getAttribute('data-tab') + '-tab';
      document.getElementById(tabId).classList.add('active');
      if (tab.getAttribute('data-tab') === 'dashboard') updateDashboard();
      else if (tab.getAttribute('data-tab') === 'manage') loadAllInvoices();
    });
  });

  const inputs = {
    customerName: document.getElementById('customerName'),
    customerEmail: document.getElementById('customerEmail'),
    customerPhone: document.getElementById('customerPhone'),
    amountPaid: document.getElementById('amountPaid'),
    issuerName: document.getElementById('issuerName'),
    paymentMethod: document.getElementById('paymentMethod'),
    dueDate: document.getElementById('dueDate'),
    notes: document.getElementById('notes'),
    searchInvoiceNumber: document.getElementById('searchInvoiceNumber'),
    discountValue: document.getElementById('discountValue'),
    discountType: document.getElementById('discountType')
  };

  const emailErrorDiv = document.getElementById('emailError');
  const phoneErrorDiv = document.getElementById('phoneError');
  const itemsTableBody = document.querySelector("#itemsTable tbody");
  const subtotalEl = document.getElementById('subtotal');
  const vatEl = document.getElementById('vat');
  const totalEl = document.getElementById('total');
  const invoiceSummary = document.getElementById('invoiceSummary');
  const qrCodeDiv = document.getElementById('qrCode');
  const balanceEl = document.getElementById('balance');
  const discountAmountEl = document.getElementById('discountAmount');
  const discountRow = document.getElementById('discountRow');
  const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');
  const generateQuotationBtn = document.getElementById('generateQuotationBtn');
  const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
  const printPdfBtn = document.getElementById('printPdfBtn');
  const emailBtn = document.getElementById('emailBtn');
  const clearFormBtn = document.getElementById('clearFormBtn');
  const addItemBtn = document.getElementById('addItemBtn');
  const exportCsvBtn = document.getElementById('exportCsvBtn');

  const invoiceListContainer = document.getElementById('invoiceListContainer');
  const filterStatus = document.getElementById('filterStatus');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');
  const searchInvoiceBtn = document.getElementById('searchInvoiceBtn');
  const clearSearchBtn = document.getElementById('clearSearchBtn');
  const reviewSection = document.getElementById('reviewSection');
  const reviewInvoiceSummary = document.getElementById('reviewInvoiceSummary');
  const reviewQrCode = document.getElementById('reviewQrCode');
  const closeReviewBtn = document.getElementById('closeReviewBtn');
  const editInvoiceBtn = document.getElementById('editInvoiceBtn');
  const printReviewBtn = document.getElementById('printReviewBtn');
  const deleteInvoiceBtn = document.getElementById('deleteInvoiceBtn');

  let currentDocument = null;
  let editingDocumentId = null;

  function isValidEmail(email) {
    if (!email) return false;
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email.toLowerCase());
  }
  function isValidPhone(phone) {
    if (!phone) return false;
    const re = /^\+?\d{7,15}$/;
    return re.test(phone.trim());
  }
  function isValidContact(phone, email) {
    if (!phone && !email) return false;
    if (phone && !isValidPhone(phone)) return false;
    if (email && !isValidEmail(email)) return false;
    return true;
  }

  function validateContact() {
    let valid = true;
    const phoneVal = inputs.customerPhone.value.trim();
    const emailVal = inputs.customerEmail.value.trim();
    if (!phoneVal && !emailVal) {
      phoneErrorDiv.style.display = 'block';
      phoneErrorDiv.textContent = 'Phone is required.';
      emailErrorDiv.style.display = 'none';
      valid = false;
    } else {
      if (phoneVal && !isValidPhone(phoneVal)) {
        phoneErrorDiv.style.display = 'block';
        phoneErrorDiv.textContent = 'Invalid phone format.';
        valid = false;
      } else {
        phoneErrorDiv.style.display = 'none';
        phoneErrorDiv.textContent = '';
      }
      if (emailVal && !isValidEmail(emailVal)) {
        emailErrorDiv.style.display = 'block';
        emailErrorDiv.textContent = 'Invalid email format.';
        valid = false;
      } else {
        emailErrorDiv.style.display = 'none';
        emailErrorDiv.textContent = '';
      }
      if (!phoneVal && (emailVal && isValidEmail(emailVal))) {
        phoneErrorDiv.style.display = 'none';
      }
    }
    return valid;
  }
  inputs.customerPhone.addEventListener('input', validateContact);
  inputs.customerEmail.addEventListener('input', validateContact);

  function createItemRow(desc = '', qty = 1, price = 0, taxRate = 0) {
    const tr = document.createElement('tr');
    const createCell = (value, type = 'input', props = {}) => {
      const td = document.createElement('td');
      if (type === 'input') {
        const input = document.createElement('input');
        input.type = props.inputType || 'text';
        input.value = value;
        if (input.type === 'number') {
            if (props.min !== undefined) input.min = props.min;
            if (props.step !== undefined) input.step = props.step;
        }
        input.style.width = '100%';
        input.setAttribute('aria-label', `${props.ariaLabel || ''}`.trim());
        td.appendChild(input);
        return td;
      } else {
        td.textContent = value;
        return td;
      }
    };
    tr.appendChild(createCell(desc, 'input', { ariaLabel: 'Item Description' }));
    tr.appendChild(createCell(qty, 'input', { inputType: 'number', min: '1', step: '1', ariaLabel: 'Quantity' }));
    tr.appendChild(createCell(price, 'input', { inputType: 'number', min: '0', step: '0.01', ariaLabel: 'Unit Price' }));
    tr.appendChild(createCell(taxRate, 'input', { inputType: 'number', min: '0', step: '0.01', ariaLabel: 'VAT Rate' }));
    tr.appendChild(createCell('0.00', 'text'));
    tr.appendChild(createCell('0.00', 'text'));
    const remTd = document.createElement('td');
    const remButton = document.createElement('button');
    remButton.textContent = '√ó';
    remButton.className = 'btn-danger';
    remButton.type = 'button';
    remButton.setAttribute('aria-label', 'Remove item row');
    remButton.addEventListener('click', () => {
      tr.remove();
      updateTotals();
    });
    remTd.appendChild(remButton);
    tr.appendChild(remTd);

    const inputsInRow = tr.querySelectorAll('input');
    inputsInRow.forEach(i => {
      i.addEventListener('input', () => {
        updateItemRow(tr);
        updateTotals();
      });
    });
    return tr;
  }
  
  function updateItemRow(tr) {
    const qty = Number(tr.children[1].firstElementChild.value) || 0;
    const price = Number(tr.children[2].firstElementChild.value) || 0;
    const taxRate = Number(tr.children[3].firstElementChild.value) || 0;
    const taxAmt = qty * price * taxRate / 100;
    const lineTotal = qty * price + taxAmt;
    tr.children[4].textContent = taxAmt.toFixed(2);
    tr.children[5].textContent = lineTotal.toFixed(2);
  }

  function updateTotals() {
    let sub = 0, tax = 0;
    itemsTableBody.querySelectorAll('tr').forEach(tr => {
      const qty = Number(tr.children[1].firstElementChild.value) || 0;
      const price = Number(tr.children[2].firstElementChild.value) || 0;
      const taxAmt = Number(tr.children[4].textContent) || 0;
      sub += qty * price;
      tax += taxAmt;
    });
    let discountVal = Number(inputs.discountValue.value) || 0;
    if (inputs.discountType.value === 'percent') discountVal = sub * (discountVal / 100);
    if (discountVal > 0) {
      discountRow.style.display = 'table-row';
      discountAmountEl.textContent = discountVal.toFixed(2);
      sub -= discountVal;
    } else {
      discountRow.style.display = 'none';
      discountAmountEl.textContent = '0.00';
    }
    if (sub < 0) sub = 0;
    const grand = sub + tax;
    subtotalEl.textContent = sub.toFixed(2);
    vatEl.textContent = tax.toFixed(2);
    totalEl.textContent = grand.toFixed(2);
    const amountPaidNum = Number(inputs.amountPaid.value) || 0;
    const balanceNum = grand - amountPaidNum;
    balanceEl.textContent = balanceNum.toFixed(2) + ' UGX';
  }

  function addItem(desc = '', qty = 1, price = 0, taxRate = 0) {
    const row = createItemRow(desc, qty, price, taxRate);
    itemsTableBody.appendChild(row);
    updateTotals();
  }

  addItemBtn.addEventListener('click', () => addItem());

  function clearForm() {
    editingDocumentId = null;
    currentDocument = null;
    inputs.customerName.value = '';
    inputs.customerEmail.value = '';
    inputs.customerPhone.value = '';
    inputs.issuerName.value = '';
    inputs.paymentMethod.value = '';
    setTodayDate();
    inputs.amountPaid.value = '';
    inputs.notes.value = '';
    inputs.discountValue.value = '0';
    inputs.discountType.value = 'percent';
    invoiceSummary.textContent = '';
    qrCodeDiv.innerHTML = '';
    balanceEl.textContent = '0.00 UGX';
    saveInvoiceBtn.disabled = true;
    printPdfBtn.disabled = true;
    emailBtn.disabled = true;
    itemsTableBody.innerHTML = '';
    addItem();
    updateTotals();
    validateContact();
  }
  clearFormBtn.addEventListener('click', clearForm);

  async function genInvoiceNumber() {
    const d = new Date();
    const count = await incrementCounter('invoice');
    return 'SHS' + d.getFullYear().toString().slice(-2) + (d.getMonth()+1).toString().padStart(2, '0') + count.toString().padStart(6, '0');
  }
  async function genQuotationNumber() {
    const d = new Date();
    const count = await incrementCounter('quotation');
    return 'QTN' + d.getFullYear().toString().slice(-2) + (d.getMonth()+1).toString().padStart(2, '0') + count.toString().padStart(6, '0');
  }
  function genFiscalDocNo() {
    return 'FDN' + Math.random().toString(36).substring(2, 12).toUpperCase();
  }
  function setTodayDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = (today.getMonth() + 1).toString().padStart(2, '0');
    const dd = today.getDate().toString().padStart(2, '0');
    inputs.dueDate.value = `${yyyy}-${mm}-${dd}`;
  }
  setTodayDate();

  function itemsAreEqual(itemsA, itemsB) {
    if (itemsA.length !== itemsB.length) return false;
    const sortedA = [...itemsA].sort((a,b) => a.description.localeCompare(b.description));
    const sortedB = [...itemsB].sort((a,b) => a.description.localeCompare(b.description));
    for (let i = 0; i < sortedA.length; i++) {
      const a = sortedA[i], b = sortedB[i];
      if (
        a.description !== b.description ||
        a.quantity !== b.quantity ||
        a.unitPrice !== b.unitPrice ||
        a.taxRate !== b.taxRate
      ) {
        return false;
      }
    }
    return true;
  }

  function getPaymentStatus(amountPaid, total, dueDateStr) {
    let status = 'pending';
    const today = new Date();
    const dueDate = dueDateStr ? new Date(dueDateStr) : null;
    if (amountPaid >= total) status = 'paid';
    else if (amountPaid > 0 && amountPaid < total) status = 'partial';
    if (status === 'pending' && dueDate && today > dueDate) status = 'overdue';
    return status;
  }

  function generateSummaryText(doc) {
    let summary = `Document Number: ${doc.number}\nFiscal Document No: ${doc.fiscalDocNo}\nType: ${doc.type}\nCustomer: ${doc.customer}\nEmail: ${doc.email || '-'}\nPhone: ${doc.phone || '-'}\nIssuer: ${doc.issuerName}\nPayment Method: ${doc.paymentMethod || '-'}\nDue Date: ${doc.dueDate || '-'}\nStatus: ${doc.status.charAt(0).toUpperCase() + doc.status.slice(1)}\nDate: ${new Date(doc.date).toLocaleDateString()}\n\nItems:\n`;
    doc.items.forEach((item, i) => {
      const taxAmount = (item.quantity * item.unitPrice * item.taxRate / 100).toFixed(2);
      const lineTotal = (item.quantity * item.unitPrice + parseFloat(taxAmount)).toFixed(2);
      summary += `${i+1}. ${item.description} - Qty: ${item.quantity} Price: UGX ${item.unitPrice.toFixed(2)} VAT Rate: ${item.taxRate}% VAT: UGX ${taxAmount} Line Total: UGX ${lineTotal}\n`;
    });
    summary += `\nSubtotal: UGX ${doc.subtotal.toFixed(2)}\nTotal VAT: UGX ${doc.totalTax.toFixed(2)}\nGrand Total: UGX ${doc.total.toFixed(2)}\nAmount Paid: UGX ${doc.amountPaid.toFixed(2)}\nOutstanding Balance: UGX ${(doc.total - doc.amountPaid).toFixed(2)}\n\nNotes: \n${doc.notes || ''}`;
    return summary;
  }

  function updateSummaryAndQRCode(doc) {
    const text = generateSummaryText(doc);
    invoiceSummary.textContent = text;
    qrCodeDiv.innerHTML = '';
    QRCode.toCanvas(qrCodeDiv, `Invoice: ${doc.number}\nTotal: UGX ${doc.total.toFixed(2)}\nStatus: ${doc.status}`, { width: 150 }, err => {
      if (err) console.error(err);
    });
  }

  function validateForm() {
    if (!inputs.customerName.value.trim()) {
      alert('Customer name is required');
      inputs.customerName.focus();
      return false;
    }
    if (!inputs.issuerName.value.trim()) {
      alert('Issuer name is required');
      inputs.issuerName.focus();
      return false;
    }
    const rows = itemsTableBody.querySelectorAll('tr');
    if (rows.length === 0) {
      alert('Add at least one invoice item');
      addItemBtn.focus();
      return false;
    }
    if (!validateContact()) {
      alert('Please fix contact information errors before proceeding.');
      return false;
    }
    return true;
  }

  function getCurrentItems() {
    return Array.from(itemsTableBody.querySelectorAll('tr')).map(row => ({
      description: row.children[0].firstElementChild.value.trim(),
      quantity: Number(row.children[1].firstElementChild.value) || 0,
      unitPrice: Number(row.children[2].firstElementChild.value) || 0,
      taxRate: Number(row.children[3].firstElementChild.value) || 0
    }));
  }

  async function generateDocument(isQuotation) {
    if (!validateForm()) return;

    updateTotals();

    const currentItems = getCurrentItems();

    const allInvoices = await db.invoices.toArray();
    // Only check for duplicates when creating NEW documents (not when editing)
    if (!editingDocumentId) {
      const duplicate = allInvoices.find(inv => {
        if (inv.type !== (isQuotation ? 'quotation' : 'invoice')) return false;
        return itemsAreEqual(inv.items, currentItems);
      });
      if (duplicate) {
        alert(`A ${isQuotation ? 'quotation' : 'n invoice'} with the same items already exists (Document Number: ${duplicate.number}). Click Edit on that document to update payment status.`);
        return;
      }
    }

    const number = editingDocumentId ? currentDocument.number : (isQuotation ? await genQuotationNumber() : await genInvoiceNumber());
    const fiscalDocNo = editingDocumentId ? currentDocument.fiscalDocNo : genFiscalDocNo();
    const type = isQuotation ? 'quotation' : 'invoice';

    const subtotal = parseFloat(subtotalEl.textContent);
    const totalTax = parseFloat(vatEl.textContent);
    const total = parseFloat(totalEl.textContent);
    const amountPaid = parseFloat(inputs.amountPaid.value) || 0;
    const balance = total - amountPaid;
    const status = getPaymentStatus(amountPaid, total, inputs.dueDate.value);

    const doc = {
      number,
      fiscalDocNo,
      type,
      customer: inputs.customerName.value.trim(),
      email: inputs.customerEmail.value.trim(),
      phone: inputs.customerPhone.value.trim(),
      issuerName: inputs.issuerName.value.trim(),
      paymentMethod: inputs.paymentMethod.value,
      dueDate: inputs.dueDate.value,
      items: currentItems,
      subtotal,
      totalTax,
      total,
      amountPaid,
      balance,
      notes: inputs.notes.value.trim(),
      status,
      date: editingDocumentId ? currentDocument.date : new Date()
    };

    currentDocument = doc;
    saveInvoiceBtn.disabled = false;
    printPdfBtn.disabled = false;
    emailBtn.disabled = !doc.email;
    updateSummaryAndQRCode(doc);
  }
  generateInvoiceBtn.addEventListener('click', () => generateDocument(false));
  generateQuotationBtn.addEventListener('click', () => generateDocument(true));

  async function saveCurrentDocument() {
    if (!currentDocument) {
      alert('Generate an invoice or quotation first.');
      return;
    }
    try {
      const amountPaid = parseFloat(inputs.amountPaid.value) || 0;
      const total = parseFloat(totalEl.textContent);
      const balance = total - amountPaid;
      const status = getPaymentStatus(amountPaid, total, inputs.dueDate.value);
      
      currentDocument.customer = inputs.customerName.value.trim();
      currentDocument.email = inputs.customerEmail.value.trim();
      currentDocument.phone = inputs.customerPhone.value.trim();
      currentDocument.issuerName = inputs.issuerName.value.trim();
      currentDocument.paymentMethod = inputs.paymentMethod.value;
      currentDocument.dueDate = inputs.dueDate.value;
      currentDocument.amountPaid = amountPaid;
      currentDocument.balance = balance;
      currentDocument.status = status;
      currentDocument.notes = inputs.notes.value.trim();
      currentDocument.items = getCurrentItems();
      currentDocument.subtotal = parseFloat(subtotalEl.textContent);
      currentDocument.totalTax = parseFloat(vatEl.textContent);
      currentDocument.total = total;
      currentDocument.lastModified = new Date();
      
      if (editingDocumentId) {
        await db.invoices.update(editingDocumentId, currentDocument);
        
        // Log audit trail for edits
        await db.auditLog.add({
          documentId: editingDocumentId,
          action: `Updated - Status changed to ${status}`,
          timestamp: new Date(),
          userId: currentDocument.issuerName
        });
        
        alert('Document updated successfully!\nNew Status: ' + status.charAt(0).toUpperCase() + status.slice(1));
      } else {
        currentDocument.date = new Date();
        const docId = await db.invoices.add(currentDocument);
        
        // Log audit trail for new documents
        await db.auditLog.add({
          documentId: docId,
          action: 'Created',
          timestamp: new Date(),
          userId: currentDocument.issuerName
        });
        
        alert('Document saved successfully!');
      }
      
      // Save/Update customer data for autocomplete
      const existingCustomer = await db.customers.where('name').equals(currentDocument.customer).first();
      if (existingCustomer) {
        await db.customers.update(existingCustomer.id, {
          phone: currentDocument.phone,
          email: currentDocument.email,
          lastTransaction: new Date()
        });
      } else {
        await db.customers.add({
          name: currentDocument.customer,
          phone: currentDocument.phone,
          email: currentDocument.email,
          lastTransaction: new Date()
        });
      }
      
      saveInvoiceBtn.disabled = true;
      printPdfBtn.disabled = true;
      emailBtn.disabled = true;
      clearForm();
      loadAllInvoices();
      updateDashboard();
      await loadCustomerAutocomplete();
    } catch (e) {
      alert('Error saving document: ' + e);
    }
  }
  saveInvoiceBtn.addEventListener('click', saveCurrentDocument);

  function printInvoice() {
    if (!currentDocument) {
      alert('Generate an invoice or quotation first.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text(settings.companyName, 105, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    if (settings.companyAddress) {
      doc.text(settings.companyAddress, 105, yPos, { align: 'center' });
      yPos += 5;
    }
    if (settings.companyPhone || settings.companyEmail) {
      const contactLine = [settings.companyPhone, settings.companyEmail].filter(Boolean).join(' | ');
      doc.text(contactLine, 105, yPos, { align: 'center' });
      yPos += 5;
    }
    if (settings.uraTin) {
      doc.text('TIN: ' + settings.uraTin, 105, yPos, { align: 'center' });
      yPos += 10;
    } else {
      yPos += 5;
    }
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    const docTitle = currentDocument.type === 'quotation' ? 'QUOTATION' : 'INVOICE';
    doc.text(docTitle, 105, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`${docTitle} #: ${currentDocument.number}`, 14, yPos);
    yPos += 5;
    doc.text(`Fiscal Doc No: ${currentDocument.fiscalDocNo}`, 14, yPos);
    yPos += 5;
    doc.text(`Date: ${new Date(currentDocument.date).toLocaleDateString()}`, 14, yPos);
    if (currentDocument.dueDate) {
      yPos += 5;
      doc.text(`Due Date: ${currentDocument.dueDate}`, 14, yPos);
    }
    yPos += 10;
    
    const leftCol = 14;
    const rightCol = 110;
    
    doc.setFont(undefined, 'bold');
    doc.text('BILL TO:', leftCol, yPos);
    doc.text('ISSUED BY:', rightCol, yPos);
    yPos += 6;
    
    doc.setFont(undefined, 'normal');
    doc.text(currentDocument.customer, leftCol, yPos);
    doc.text(currentDocument.issuerName, rightCol, yPos);
    yPos += 5;
    
    if (currentDocument.phone) {
      doc.text(`Phone: ${currentDocument.phone}`, leftCol, yPos);
    }
    yPos += 5;
    
    if (currentDocument.email) {
      doc.text(`Email: ${currentDocument.email}`, leftCol, yPos);
      yPos += 5;
    }
    
    if (currentDocument.paymentMethod) {
      doc.text(`Payment Method: ${currentDocument.paymentMethod}`, leftCol, yPos);
      yPos += 5;
    }
    
    yPos += 5;
    
    const tableData = currentDocument.items.map(item => {
      const vatAmount = (item.quantity * item.unitPrice * item.taxRate / 100);
      const lineTotal = (item.quantity * item.unitPrice + vatAmount);
      return [
        item.description,
        item.quantity.toString(),
        'UGX ' + item.unitPrice.toFixed(2),
        item.taxRate.toFixed(1) + '%',
        'UGX ' + vatAmount.toFixed(2),
        'UGX ' + lineTotal.toFixed(2)
      ];
    });
    
    doc.autoTable({
      startY: yPos,
      head: [['Description', 'Qty', 'Unit Price', 'VAT Rate', 'VAT Amount', 'Total']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [102, 126, 234], 
        fontSize: 10,
        fontStyle: 'bold'
      },
      bodyStyles: { 
        fontSize: 10
      },
      columnStyles: {
        0: { cellWidth: 60 },
        1: { cellWidth: 15, halign: 'center' },
        2: { cellWidth: 30, halign: 'right' },
        3: { cellWidth: 20, halign: 'center' },
        4: { cellWidth: 30, halign: 'right' },
        5: { cellWidth: 35, halign: 'right' }
      }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    const totalsX = 140;
    
    doc.setFontSize(10);
    doc.text('Subtotal:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.subtotal.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 6;
    
    const discountVal = Number(inputs.discountValue.value) || 0;
    if (discountVal > 0) {
      const discountAmount = inputs.discountType.value === 'percent' 
        ? (currentDocument.subtotal * discountVal / 100)
        : discountVal;
      const discountLabel = inputs.discountType.value === 'percent' 
        ? `Discount (${discountVal}%):`
        : 'Discount:';
      doc.text(discountLabel, totalsX, yPos, { align: 'right' });
      doc.text('UGX ' + discountAmount.toFixed(2), 196, yPos, { align: 'right' });
      yPos += 6;
    }
    
    doc.text('Total VAT:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.totalTax.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 8;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('GRAND TOTAL:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.total.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Amount Paid:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.amountPaid.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 6;
    
    doc.setFont(undefined, 'bold');
    doc.text('Balance Due:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.balance.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 10;
    
    doc.setFontSize(11);
    const statusText = 'Status: ' + currentDocument.status.charAt(0).toUpperCase() + currentDocument.status.slice(1);
    doc.text(statusText, 14, yPos);
    yPos += 10;
    
    if (currentDocument.notes && currentDocument.notes.trim()) {
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text('Notes:', 14, yPos);
      yPos += 5;
      doc.setFont(undefined, 'normal');
      const splitNotes = doc.splitTextToSize(currentDocument.notes, 180);
      doc.text(splitNotes, 14, yPos);
      yPos += (splitNotes.length * 5);
    }
    
    if (yPos < 270) {
      yPos = 270;
    }
    doc.setFontSize(9);
    doc.setFont(undefined, 'italic');
    doc.text('Thank you for your business!', 105, yPos, { align: 'center' });
    
    doc.save(`${currentDocument.number}.pdf`);
  }
  printPdfBtn.addEventListener('click', printInvoice);

  function emailInvoice() {
    if (!currentDocument) {
      alert('Generate an invoice or quotation first.');
      return;
    }
    if (!inputs.customerEmail.value.trim()) {
      alert('Enter customer email to send.');
      return;
    }
    const subject = encodeURIComponent(`Invoice ${currentDocument.number}`);
    const body = encodeURIComponent(invoiceSummary.textContent);
    const mailto = `mailto:${inputs.customerEmail.value}?subject=${subject}&body=${body}`;
    window.location.href = mailto;
  }
  emailBtn.addEventListener('click', emailInvoice);

  exportCsvBtn.addEventListener('click', () => {
    if (!currentDocument) {
      alert('Generate an invoice or quotation first.');
      return;
    }
    const header = ['Description', 'Quantity', 'Unit Price', 'VAT Rate', 'VAT Amount', 'Line Total'];
    const rows = currentDocument.items.map(item => {
      const vatAmount = (item.quantity * item.unitPrice * item.taxRate / 100).toFixed(2);
      const lineTotal = (item.quantity * item.unitPrice + parseFloat(vatAmount)).toFixed(2);
      const escapedDesc = `"${item.description.replace(/"/g, '""')}"`;
      return [escapedDesc, item.quantity, item.unitPrice.toFixed(2), item.taxRate.toFixed(2), vatAmount, lineTotal];
    });
    const csvContent = [header, ...rows].map(e => e.join(',')).join('\n');
    const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentDocument.number}_items.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  async function getCounter(type) {
    const counter = await db.counters.get(type);
    return counter ? counter.count : 0;
  }
  async function incrementCounter(type) {
    const current = await getCounter(type);
    const newCount = current + 1;
    await db.counters.put({ type, count: newCount });
    return newCount;
  }

  async function loadAllInvoices() {
    const allInvoices = await db.invoices.toArray();
    displayInvoices(allInvoices);
    reviewSection.style.display = 'none';
  }

  function matchesFilter(invoice, searchTerm, statusFilter, fromDate, toDate) {
    const term = searchTerm.toLowerCase();
    const invoiceDate = new Date(invoice.date);
    const from = fromDate ? new Date(fromDate) : null;
    const to = toDate ? new Date(toDate) : null;
    const matchesTerm =
      (!term) || invoice.number.toLowerCase().includes(term) ||
      invoice.customer.toLowerCase().includes(term) ||
      (invoice.phone && invoice.phone.toLowerCase().includes(term));
    const matchesStatus = statusFilter ?
      (invoice.status === statusFilter || invoice.type === statusFilter)
      : true;
    const matchesDate =
      (!from || invoiceDate >= from) &&
      (!to || invoiceDate <= to);
    return matchesTerm && matchesStatus && matchesDate;
  }

  function displayInvoices(invoices) {
    invoiceListContainer.innerHTML = '';
    if (invoices.length === 0) {
      invoiceListContainer.textContent = 'No documents found.';
      return;
    }
    invoices.forEach(inv => {
      const div = document.createElement('div');
      div.className = 'invoice-item';
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      div.setAttribute('aria-pressed', 'false');
      div.innerHTML = `
        <div class="invoice-item-header">
          <div class="invoice-number">${inv.number}</div>
          <div class="invoice-date">${new Date(inv.date).toLocaleDateString()}</div>
        </div>
        <div class="invoice-customer">${inv.customer}</div>
        <div class="invoice-amount">UGX ${inv.total.toFixed(2)}</div>
        <div>Status: <span class="status-badge ${
          inv.status === 'paid' ? 'status-paid' :
          inv.status === 'partial' ? 'status-partial' :
          inv.status === 'pending' ? 'status-pending' :
          inv.status === 'overdue' ? 'status-overdue' :
          inv.type === 'quotation' ? 'status-quotation' : ''
        }">${inv.status.charAt(0).toUpperCase() + inv.status.slice(1)}</span></div>
      `;
      div.addEventListener('click', () => showInvoiceReview(inv));
      div.addEventListener('keydown', (e) => { if(e.key==='Enter') showInvoiceReview(inv); });
      invoiceListContainer.appendChild(div);
    });
  }

  searchInvoiceBtn.addEventListener('click', async () => {
    const searchTerm = inputs.searchInvoiceNumber.value.trim();
    const status = filterStatus.value;
    const fromDateVal = dateFrom.value;
    const toDateVal = dateTo.value;
    const allInvoices = await db.invoices.toArray();
    const filtered = allInvoices.filter(inv => matchesFilter(inv, searchTerm, status, fromDateVal, toDateVal));
    displayInvoices(filtered);
    reviewSection.style.display = 'none';
  });

  clearSearchBtn.addEventListener('click', () => {
    inputs.searchInvoiceNumber.value = '';
    filterStatus.value = '';
    dateFrom.value = '';
    dateTo.value = '';
    loadAllInvoices();
  });

  function showInvoiceReview(invoice) {
    reviewInvoiceSummary.textContent = generateSummaryText(invoice);
    reviewQrCode.innerHTML = '';
    QRCode.toCanvas(reviewQrCode, `Invoice: ${invoice.number}\nTotal: UGX ${invoice.total.toFixed(2)}\nStatus: ${invoice.status}`, { width: 150 }, err => {
      if (err) console.error(err);
    });
    reviewSection.style.display = 'block';
    currentDocument = invoice;
    editingDocumentId = invoice.id;
    saveInvoiceBtn.disabled = true;
    printPdfBtn.disabled = true;
    emailBtn.disabled = true;
  }

  closeReviewBtn.addEventListener('click', () => {
    reviewSection.style.display = 'none';
    currentDocument = null;
    editingDocumentId = null;
  });

  editInvoiceBtn.addEventListener('click', () => {
    if (!currentDocument) return;
    reviewSection.style.display = 'none';
    itemsTableBody.innerHTML = '';
    editingDocumentId = currentDocument.id;
    inputs.customerName.value = currentDocument.customer;
    inputs.customerEmail.value = currentDocument.email;
    inputs.customerPhone.value = currentDocument.phone;
    inputs.issuerName.value = currentDocument.issuerName;
    inputs.paymentMethod.value = currentDocument.paymentMethod;
    inputs.dueDate.value = currentDocument.dueDate || '';
    inputs.amountPaid.value = currentDocument.amountPaid.toFixed(2);
    inputs.notes.value = currentDocument.notes;
    inputs.discountValue.value = '0';
    inputs.discountType.value = 'percent';
    currentDocument.items.forEach(item => addItem(item.description, item.quantity, item.unitPrice, item.taxRate));
    updateTotals();
    
    invoiceSummary.textContent = generateSummaryText(currentDocument);
    qrCodeDiv.innerHTML = '';
    QRCode.toCanvas(qrCodeDiv, `Invoice: ${currentDocument.number}\nTotal: UGX ${currentDocument.total.toFixed(2)}\nStatus: ${currentDocument.status}`, { width: 150 }, err => {
      if (err) console.error(err);
    });
    
    saveInvoiceBtn.disabled = false;
    printPdfBtn.disabled = false;
    emailBtn.disabled = !currentDocument.email;
    document.getElementById('tab-create').click();
  });

  printReviewBtn.addEventListener('click', () => {
    if (!currentDocument) {
      alert('Select a document first.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text(settings.companyName, 105, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    if (settings.companyAddress) {
      doc.text(settings.companyAddress, 105, yPos, { align: 'center' });
      yPos += 5;
    }
    if (settings.companyPhone || settings.companyEmail) {
      const contactLine = [settings.companyPhone, settings.companyEmail].filter(Boolean).join(' | ');
      doc.text(contactLine, 105, yPos, { align: 'center' });
      yPos += 5;
    }
    if (settings.uraTin) {
      doc.text('TIN: ' + settings.uraTin, 105, yPos, { align: 'center' });
      yPos += 10;
    } else {
      yPos += 5;
    }
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    const docTitle = currentDocument.type === 'quotation' ? 'QUOTATION' : 'INVOICE';
    doc.text(docTitle, 105, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`${docTitle} #: ${currentDocument.number}`, 14, yPos);
    yPos += 5;
    doc.text(`Fiscal Doc No: ${currentDocument.fiscalDocNo}`, 14, yPos);
    yPos += 5;
    doc.text(`Date: ${new Date(currentDocument.date).toLocaleDateString()}`, 14, yPos);
    if (currentDocument.dueDate) {
      yPos += 5;
      doc.text(`Due Date: ${currentDocument.dueDate}`, 14, yPos);
    }
    yPos += 10;
    
    const leftCol = 14;
    const rightCol = 110;
    
    doc.setFont(undefined, 'bold');
    doc.text('BILL TO:', leftCol, yPos);
    doc.text('ISSUED BY:', rightCol, yPos);
    yPos += 6;
    
    doc.setFont(undefined, 'normal');
    doc.text(currentDocument.customer, leftCol, yPos);
    doc.text(currentDocument.issuerName, rightCol, yPos);
    yPos += 5;
    
    if (currentDocument.phone) {
      doc.text(`Phone: ${currentDocument.phone}`, leftCol, yPos);
    }
    yPos += 5;
    
    if (currentDocument.email) {
      doc.text(`Email: ${currentDocument.email}`, leftCol, yPos);
      yPos += 5;
    }
    
    if (currentDocument.paymentMethod) {
      doc.text(`Payment Method: ${currentDocument.paymentMethod}`, leftCol, yPos);
      yPos += 5;
    }
    
    yPos += 5;
    
    const tableData = currentDocument.items.map(item => {
      const vatAmount = (item.quantity * item.unitPrice * item.taxRate / 100);
      const lineTotal = (item.quantity * item.unitPrice + vatAmount);
      return [
        item.description,
        item.quantity.toString(),
        'UGX ' + item.unitPrice.toFixed(2),
        item.taxRate.toFixed(1) + '%',
        'UGX ' + vatAmount.toFixed(2),
        'UGX ' + lineTotal.toFixed(2)
      ];
    });
    
    doc.autoTable({
      startY: yPos,
      head: [['Description', 'Qty', 'Unit Price', 'VAT Rate', 'VAT Amount', 'Total']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [102, 126, 234], 
        fontSize: 10,
        fontStyle: 'bold'
      },
      bodyStyles: { 
        fontSize: 10
      },
      columnStyles: {
        0: { cellWidth: 60 },
        1: { cellWidth: 15, halign: 'center' },
        2: { cellWidth: 30, halign: 'right' },
        3: { cellWidth: 20, halign: 'center' },
        4: { cellWidth: 30, halign: 'right' },
        5: { cellWidth: 35, halign: 'right' }
      }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    const totalsX = 140;
    
    doc.setFontSize(10);
    doc.text('Subtotal:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.subtotal.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 6;
    
    doc.text('Total VAT:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.totalTax.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 8;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('GRAND TOTAL:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.total.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Amount Paid:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.amountPaid.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 6;
    
    doc.setFont(undefined, 'bold');
    doc.text('Balance Due:', totalsX, yPos, { align: 'right' });
    doc.text('UGX ' + currentDocument.balance.toFixed(2), 196, yPos, { align: 'right' });
    yPos += 10;
    
    doc.setFontSize(11);
    const statusText = 'Status: ' + currentDocument.status.charAt(0).toUpperCase() + currentDocument.status.slice(1);
    doc.text(statusText, 14, yPos);
    yPos += 10;
    
    if (currentDocument.notes && currentDocument.notes.trim()) {
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text('Notes:', 14, yPos);
      yPos += 5;
      doc.setFont(undefined, 'normal');
      const splitNotes = doc.splitTextToSize(currentDocument.notes, 180);
      doc.text(splitNotes, 14, yPos);
      yPos += (splitNotes.length * 5);
    }
    
    if (yPos < 270) {
      yPos = 270;
    }
    doc.setFontSize(9);
    doc.setFont(undefined, 'italic');
    doc.text('Thank you for your business!', 105, yPos, { align: 'center' });
    
    doc.save(`${currentDocument.number}.pdf`);
  });

  deleteInvoiceBtn.addEventListener('click', async () => {
    if (!currentDocument) return;
    if (!confirm(`Are you sure you want to delete document ${currentDocument.number}?`)) return;
    try {
      await db.invoices.delete(currentDocument.id);
      alert('Document deleted successfully.');
      reviewSection.style.display = 'none';
      loadAllInvoices();
      updateDashboard();
      currentDocument = null;
      editingDocumentId = null;
    } catch (e) {
      alert('Failed to delete document: ' + e);
    }
  });

  async function updateDashboard() {
    const allInvoices = await db.invoices.toArray();
    const paidInvoices = allInvoices.filter(inv => inv.status === 'paid' && inv.type === 'invoice');
    const pendingInvoices = allInvoices.filter(inv => (inv.status === 'pending' || inv.status === 'partial' || inv.status === 'overdue') && inv.type === 'invoice');
    const quotations = allInvoices.filter(inv => inv.type === 'quotation');

    const totalSales = paidInvoices.reduce((acc, inv) => acc + inv.total, 0);
    const pendingPayments = pendingInvoices.reduce((acc, inv) => acc + (inv.total - (inv.amountPaid || 0)), 0);
    const totalInvoices = allInvoices.filter(inv => inv.type === 'invoice').length;

    document.getElementById('statTotalSales').textContent = totalSales.toLocaleString() + ' UGX';
    document.getElementById('statPending').textContent = pendingPayments.toLocaleString() + ' UGX';
    document.getElementById('statInvoiceCount').textContent = totalInvoices.toString();
    document.getElementById('statQuotationCount').textContent = quotations.length.toString();

    const sortedRecent = allInvoices.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
    const recentDiv = document.getElementById('recentInvoices');
    recentDiv.innerHTML = '';
    if (sortedRecent.length === 0) {
      recentDiv.textContent = 'No recent documents.';
      return;
    }
    sortedRecent.forEach(inv => {
      const div = document.createElement('div');
      div.className = 'invoice-item';
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      div.setAttribute('aria-pressed', 'false');
      div.innerHTML = `
        <div class="invoice-item-header">
          <div class="invoice-number">${inv.number}</div>
          <div class="invoice-date">${new Date(inv.date).toLocaleDateString()}</div>
        </div>
        <div class="invoice-customer">${inv.customer}</div>
        <div class="invoice-amount">UGX ${inv.total.toFixed(2)}</div>
        <div>Status: <span class="status-badge ${
          inv.status === 'paid' ? 'status-paid' :
          inv.status === 'partial' ? 'status-partial' :
          inv.status === 'pending' ? 'status-pending' :
          inv.status === 'overdue' ? 'status-overdue' :
          inv.type === 'quotation' ? 'status-quotation' : ''
        }">${inv.status.charAt(0).toUpperCase() + inv.status.slice(1)}</span></div>
      `;
      div.addEventListener('click', () => showInvoiceReview(inv));
      div.addEventListener('keydown', (e) => { if(e.key==='Enter') showInvoiceReview(inv); });
      recentDiv.appendChild(div);
    });
  }

  loadSettings();
  clearForm();
  loadCustomerAutocomplete();
  
  // Load customer autocomplete data
  async function loadCustomerAutocomplete() {
    const customers = await db.customers.orderBy('lastTransaction').reverse().toArray();
    const datalist = document.getElementById('customerList');
    datalist.innerHTML = '';
    customers.forEach(customer => {
      const option = document.createElement('option');
      option.value = customer.name;
      option.setAttribute('data-phone', customer.phone);
      option.setAttribute('data-email', customer.email);
      datalist.appendChild(option);
    });
  }
  
  // Auto-fill customer details when selected from list
  inputs.customerName.addEventListener('input', async () => {
    const selectedName = inputs.customerName.value;
    const customer = await db.customers.where('name').equals(selectedName).first();
    if (customer) {
      inputs.customerPhone.value = customer.phone || '';
      inputs.customerEmail.value = customer.email || '';
      validateContact();
    }
  });

});
</script>
</body>
</html>
